<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–—åœ°ä¸» - V6 æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-neon-blue: #00e0ff;
            --color-neon-pink: #ff1080;
            --color-bg-dark: #12121e;
            --color-metal-dark: #222233;
            --color-hazard-yellow: #ffc400;
            --card-width: 56px;
            --card-height: 84px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; transition: all 0.2s ease-out; }
        body {
            height: 100vh; width: 100vw;
            background: linear-gradient(rgba(18, 18, 30, 0.9), rgba(18, 18, 30, 0.9)), repeating-linear-gradient(45deg, var(--color-metal-dark), var(--color-metal-dark) 2px, #1c1c28 3px, #1c1c28 5px);
            font-family: 'Roboto Mono', monospace; overflow: hidden; display: flex; flex-direction: column;
        }

        #game-table { flex: 1; position: relative; width: 100%; perspective: 1000px; }
        #top-bar { position: absolute; top: 15px; width: 100%; display: flex; justify-content: center; gap: 8px; z-index: 10; }

        .player-avatar {
            position: absolute; top: 10%; width: 90px; padding: 5px;
            border: 1px solid var(--color-neon-blue); background: rgba(0, 224, 255, 0.1);
            border-radius: 4px; box-shadow: 0 0 10px var(--color-neon-blue); color: #fff; font-size: 12px; text-align: center;
        }
        .player-avatar.left { left: 10px; }
        .player-avatar.right { right: 10px; }
        .active-turn { border: 2px solid var(--color-hazard-yellow); box-shadow: 0 0 15px var(--color-hazard-yellow); }

        /* --- ç‰Œé¢æ ·å¼ --- */
        .card {
            width: var(--card-width); height: var(--card-height); background: #fff; border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.6); position: relative; display: block; border: 1px solid #aaa;
        }
        .card.back {
            background: linear-gradient(135deg, var(--color-neon-blue), var(--color-metal-dark));
            border: 2px solid var(--color-neon-pink);
        }
        .card.red { color: #e74c3c; } /* çº¢è‰² */
        .card.black { color: #2c3e50; } /* é»‘è‰² */
        
        .card .rank-corner { position: absolute; top: 2px; left: 2px; font-weight: bold; font-size: 18px; line-height: 1; text-align: center; width: 20px;}
        .card .suit-mini { font-size: 12px; display: block; }
        .card .big-suit { position: absolute; bottom: 2px; right: 2px; font-size: 24px; }

        /* ç‰¹æ®Šç‰Œæ ·å¼ï¼šç‹ */
        .card.joker-big { color: #d32f2f; border: 2px solid #d32f2f; background: #fff0f0; }
        .card.joker-small { color: #212121; border: 2px solid #212121; background: #f0f0f0; }

        /* --- æ‰‹ç‰Œå®¹å™¨ (å¹³é“ºæ— å¼§åº¦) --- */
        #player-zone { height: 260px; position: relative; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 10px; }
        #hand-container {
            position: relative; height: 100px; width: 100%; 
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .my-card {
            position: relative; 
            margin-left: -35px; /* å¹³é“ºé‡å  */
            transition: transform 0.1s; /* å¿«é€Ÿå“åº” */
        }
        .my-card:first-child { margin-left: 0; }
        .my-card.selected { transform: translateY(-20px); z-index: 100; border: 2px solid var(--color-hazard-yellow); }

        /* --- å‡ºç‰ŒåŒº --- */
        .played-area { position: absolute; display: flex; gap: -30px; }
        #play-left { top: 35%; left: 100px; }
        #play-right { top: 35%; right: 100px; justify-content: flex-end;}
        #play-center { top: 50%; left: 50%; transform: translateX(-50%); }

        /* --- æŒ‰é’® --- */
        #controls { position: absolute; top: 10px; width: 100%; display: flex; justify-content: center; gap: 15px; z-index: 200; }
        .btn {
            background: var(--color-neon-blue); color: #000; border: none; padding: 10px 20px;
            font-weight: bold; font-size: 16px; border-radius: 4px; box-shadow: 0 4px 0 #0099ff;
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        #msg-toast {
            position: absolute; top: -50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: var(--color-hazard-yellow); padding: 8px 16px;
            border-radius: 20px; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #msg-toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="game-table">
        <div id="top-bar">
            <div class="card back" id="base-1"></div>
            <div class="card back" id="base-2"></div>
            <div class="card back" id="base-3"></div>
        </div>

        <div class="player-avatar left" id="avatar-west">
            <div>ğŸ¤– ç”µè„‘(å·¦)</div>
            <div id="count-west" style="font-size:16px; color:var(--color-neon-blue)">17</div>
            <div id="role-west" style="color:var(--color-neon-pink)"></div>
        </div>

        <div class="player-avatar right" id="avatar-east">
            <div>ğŸ¤  ç”µè„‘(å³)</div>
            <div id="count-east" style="font-size:16px; color:var(--color-neon-blue)">17</div>
            <div id="role-east" style="color:var(--color-neon-pink)"></div>
        </div>

        <div id="play-left" class="played-area"></div>
        <div id="play-right" class="played-area"></div>
        <div id="play-center" class="played-area"></div>
    </div>

    <div id="player-zone">
        <div id="msg-toast">æç¤ºä¿¡æ¯</div>
        
        <div id="controls">
            <button class="btn" id="btn-start" onclick="game.init()">å¼€å§‹æ¸¸æˆ</button>
            <div id="group-bid" style="display:none; gap:15px;">
                <button class="btn" onclick="game.playerBid(true)">å«åœ°ä¸»</button>
                <button class="btn" style="background:#555; color:#fff; box-shadow:0 4px 0 #333" onclick="game.playerBid(false)">ä¸å«</button>
            </div>
            <div id="group-play" style="display:none; gap:15px;">
                <button class="btn" style="background:#ff1080; box-shadow:0 4px 0 #cc0066; color:#fff" id="btn-pass" onclick="game.playerPass()">ä¸å‡º</button>
                <button class="btn" onclick="game.playerPlay()">å‡ºç‰Œ</button>
            </div>
        </div>

        <div id="hand-container"></div>
    </div>

<script>
const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2'];

class Card {
    constructor(val, suit = '') {
        this.val = val; 
        this.suit = suit;
        this.selected = false;
        this.id = Math.random().toString(36).substr(2, 9);
    }
    
    get isBigJoker() { return this.val === 17; }
    get isSmallJoker() { return this.val === 16; }

    get display() {
        if (this.isSmallJoker) return 'å°ç‹';
        if (this.isBigJoker) return 'å¤§ç‹';
        return RANKS[this.val - 3];
    }

    get colorClass() {
        if (this.isBigJoker) return 'joker-big';
        if (this.isSmallJoker) return 'joker-small';
        if (this.suit === 'â™¥' || this.suit === 'â™¦') return 'red';
        return 'black';
    }
}

class Game {
    constructor() {
        this.reset();
        this.els = {
            hand: document.getElementById('hand-container'),
            controls: {
                start: document.getElementById('btn-start'),
                bid: document.getElementById('group-bid'),
                play: document.getElementById('group-play'),
                pass: document.getElementById('btn-pass')
            },
            played: {
                west: document.getElementById('play-left'),
                east: document.getElementById('play-right'),
                south: document.getElementById('play-center')
            },
            base: [document.getElementById('base-1'), document.getElementById('base-2'), document.getElementById('base-3')],
            counts: { west: document.getElementById('count-west'), east: document.getElementById('count-east') },
            badges: { west: document.getElementById('role-west'), east: document.getElementById('role-east') },
            toast: document.getElementById('msg-toast'),
            avatars: { west: document.getElementById('avatar-west'), east: document.getElementById('avatar-east') }
        };
    }

    reset() {
        this.deck = [];
        this.hands = { south: [], west: [], east: [] };
        this.baseCards = [];
        this.landlord = null;
        this.turn = null; 
        this.lastPlay = null; // { player, cards, type, val }
        this.passCount = 0;
    }

    init() {
        this.reset();
        this.createDeck();
        this.shuffle();
        this.deal();
        
        this.els.controls.start.style.display = 'none';
        this.els.played.west.innerHTML = '';
        this.els.played.east.innerHTML = '';
        this.els.played.south.innerHTML = '';
        this.els.base.forEach(el => { el.className = 'card back'; el.innerHTML = ''; });
        this.els.badges.west.innerText = '';
        this.els.badges.east.innerText = '';
        
        this.renderHand();
        this.updateCounts();
        
        this.showToast('è¯·å«åœ°ä¸»');
        this.els.controls.bid.style.display = 'flex';
        this.els.controls.play.style.display = 'none';
    }

    createDeck() {
        for(let v=3; v<=15; v++) {
            for(let s of SUITS) {
                this.deck.push(new Card(v, s));
            }
        }
        this.deck.push(new Card(16)); // å°ç‹
        this.deck.push(new Card(17)); // å¤§ç‹
    }

    shuffle() { this.deck.sort(() => Math.random() - 0.5); }

    deal() {
        this.baseCards = this.deck.splice(0, 3);
        for(let i=0; i<17; i++) {
            this.hands.south.push(this.deck.pop());
            this.hands.west.push(this.deck.pop());
            this.hands.east.push(this.deck.pop());
        }
        this.sortHand('south');
        this.sortHand('west');
        this.sortHand('east');
    }

    sortHand(who) { this.hands[who].sort((a,b) => b.val - a.val); }

    updateCounts() {
        this.els.counts.west.innerText = this.hands.west.length;
        this.els.counts.east.innerText = this.hands.east.length;
    }

    showToast(msg) {
        this.els.toast.innerText = msg;
        this.els.toast.classList.add('show');
        setTimeout(() => this.els.toast.classList.remove('show'), 2000);
    }

    highlightAvatar(who) {
        this.els.avatars.west.classList.remove('active-turn');
        this.els.avatars.east.classList.remove('active-turn');
        if(who === 'west') this.els.avatars.west.classList.add('active-turn');
        if(who === 'east') this.els.avatars.east.classList.add('active-turn');
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šæ¸²æŸ“æ‰‹ç‰Œ (å»é™¤å¼§åº¦ï¼Œä¿®æ­£ç‹ç‰Œ) ---
    renderHand() {
        this.els.hand.innerHTML = '';
        this.hands.south.forEach((card, idx) => {
            const el = document.createElement('div');
            el.className = `card my-card ${card.colorClass}`;
            if(card.selected) el.classList.add('selected');
            
            let rankHtml = card.display;
            let suitHtml = card.suit;
            
            // ä¿®æ­£ç‹ç‰Œæ˜¾ç¤º
            if (card.isSmallJoker) { rankHtml = 'Joker'; suitHtml = 'S'; }
            if (card.isBigJoker) { rankHtml = 'JOKER'; suitHtml = 'B'; }

            el.innerHTML = `
                <div class="rank-corner" style="${(card.isSmallJoker||card.isBigJoker)?'font-size:12px; writing-mode:vertical-rl; top:4px;':''}">
                    ${rankHtml}
                    ${(!card.isSmallJoker && !card.isBigJoker) ? `<div class="suit-mini">${suitHtml}</div>` : ''}
                </div>
                <div class="big-suit">${suitHtml}</div>
            `;
            
            el.onclick = () => {
                card.selected = !card.selected;
                // ç›´æ¥æ“ä½œ DOM æå‡æ€§èƒ½ï¼Œä¸å®Œå…¨é‡ç»˜
                if(card.selected) el.classList.add('selected');
                else el.classList.remove('selected');
            };
            
            el.style.zIndex = idx;
            this.els.hand.appendChild(el);
        });
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šå«åœ°ä¸»æµç¨‹ ---
    playerBid(wants) {
        this.els.controls.bid.style.display = 'none';
        let winner = 'south'; // å¦‚æœä¸æƒ³å†™ AI å«ç‰Œï¼Œé»˜è®¤ç»™ç©å®¶ï¼Œæ–¹ä¾¿æµ‹è¯•
        if(!wants) {
            // ç®€å•éšæœºç»™ä¸ªç”µè„‘
            winner = Math.random() > 0.5 ? 'east' : 'west';
        }
        this.setLandlord(winner);
    }

    setLandlord(who) {
        this.landlord = who;
        this.hands[who].push(...this.baseCards);
        this.sortHand(who);
        
        // æ˜¾ç¤ºåº•ç‰Œ
        this.els.base.forEach((el, i) => {
            const c = this.baseCards[i];
            el.className = `card ${c.colorClass}`;
            el.innerHTML = `<div class="rank-corner">${c.display}</div>`;
        });

        if(who !== 'south') {
            document.getElementById(`role-${who}`).innerText = '[åœ°ä¸»]';
        } else {
            this.showToast('ä½ æ˜¯åœ°ä¸»ï¼');
            this.renderHand(); // ç©å®¶æ‰‹ç‰Œå˜äº†ï¼Œé‡ç»˜
        }
        this.updateCounts();

        this.turn = who;
        this.passCount = 0; // é‡ç½®è¿‡ç‰Œæ•°
        this.lastPlay = null; // é‡ç½®ä¸Šå®¶ç‰Œ
        
        this.runTurn(); // ç«‹å³å¼€å§‹å›åˆ
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šå›åˆé€»è¾‘ ---
    runTurn() {
        this.highlightAvatar(this.turn);
        
        if(this.turn === 'south') {
            this.els.controls.play.style.display = 'flex';
            
            // åˆ¤æ–­æ˜¯å¦è‡ªç”±å‡ºç‰Œï¼š1. åˆšå¼€å§‹ 2. è‡ªå·±å‡ºçš„ç‰Œè½¬å›æ¥äº† 3. å¤§å®¶éƒ½ä¸è¦
            const isFree = (this.lastPlay === null || this.lastPlay.player === 'south');
            
            // è‡ªç”±å‡ºç‰Œæ—¶ï¼Œä¸èƒ½ç‚¹â€œä¸å‡ºâ€
            if (isFree) {
                this.els.controls.pass.style.display = 'none';
                this.showToast('è¯·å‡ºç‰Œ');
            } else {
                this.els.controls.pass.style.display = 'block';
                this.showToast('è½®åˆ°ä½ äº†');
            }
        } else {
            this.els.controls.play.style.display = 'none';
            setTimeout(() => this.aiPlay(), 1000);
        }
    }

    playerPass() {
        if (this.lastPlay === null || this.lastPlay.player === 'south') return; // è‡ªç”±å‡ºç‰Œä¸èƒ½è¿‡
        this.passCount++;
        this.renderPlayed('south', []);
        this.nextTurn();
    }

    playerPlay() {
        const selected = this.hands.south.filter(c => c.selected);
        if(selected.length === 0) { this.showToast('è¯·é€‰ç‰Œ'); return; }

        const typeInfo = this.checkType(selected);
        if(!typeInfo) { this.showToast('ç‰Œå‹ä¸åˆæ³•'); return; }

        const isFree = (this.lastPlay === null || this.lastPlay.player === 'south');

        if(!isFree) {
            if(!this.canBeat(typeInfo, this.lastPlay)) {
                this.showToast('æ‰“ä¸è¿‡'); return;
            }
        }

        // å‡ºç‰ŒæˆåŠŸ
        this.hands.south = this.hands.south.filter(c => !c.selected);
        this.renderHand();
        
        this.lastPlay = { player: 'south', cards: selected, ...typeInfo };
        this.passCount = 0; // æœ‰äººå‡ºç‰Œï¼Œæ¸…é›¶è¿‡ç‰Œæ•°
        
        this.renderPlayed('south', selected);
        this.checkWin('south');
    }

    aiPlay() {
        const hand = this.hands[this.turn];
        let toPlay = [];
        const isFree = (this.lastPlay === null || this.lastPlay.player === this.turn);

        if(isFree) {
            // è‡ªç”±å‡ºç‰Œï¼šå‡ºæœ€å°å•å¼ 
            toPlay = [hand[hand.length-1]];
        } else {
            // å‹ç‰Œé€»è¾‘ï¼šæ‰¾ä¸ªæ¯”ä¸Šå®¶å¤§çš„å•å¼ 
            const target = this.lastPlay;
            if(target.type === 'single') {
                const c = hand.slice().reverse().find(x => x.val > target.val);
                if(c) toPlay = [c];
            }
        }

        if(toPlay.length > 0) {
            this.hands[this.turn] = hand.filter(c => !toPlay.includes(c));
            this.updateCounts();
            
            const typeInfo = this.checkType(toPlay);
            this.lastPlay = { player: this.turn, cards: toPlay, ...typeInfo };
            this.passCount = 0;
            this.renderPlayed(this.turn, toPlay);
            this.checkWin(this.turn);
        } else {
            this.passCount++;
            this.renderPlayed(this.turn, []);
            this.nextTurn();
        }
    }

    nextTurn() {
        // è½®è½¬
        if(this.turn === 'south') this.turn = 'east';
        else if(this.turn === 'east') this.turn = 'west';
        else this.turn = 'south';

        // æ ¸å¿ƒä¿®å¤ï¼šå¦‚æœè¿ç»­ä¸¤äººè¿‡ç‰Œï¼Œä¸‹ä¸€å®¶è·å¾—è‡ªç”±å‡ºç‰Œæƒ
        if(this.passCount >= 2) {
            this.lastPlay = null; // æ¸…ç©ºä¸Šå®¶ç‰Œï¼Œæ ‡è®°ä¸ºè‡ªç”±å›åˆ
            this.passCount = 0;
        }

        this.runTurn();
    }

    checkWin(who) {
        if(this.hands[who].length === 0) {
            setTimeout(() => alert(who === 'south' ? 'ä½ èµ¢äº†ï¼' : 'ç”µè„‘èµ¢äº†ï¼'), 100);
            setTimeout(() => location.reload(), 2000); // ç®€å•é‡ç½®
        } else {
            this.nextTurn();
        }
    }

    renderPlayed(who, cards) {
        const el = this.els.played[who];
        el.innerHTML = '';
        if(cards.length === 0) {
            el.innerHTML = '<span style="background:rgba(0,0,0,0.5);color:#fff;padding:5px;">ä¸å‡º</span>';
            return;
        }
        cards.forEach(c => {
            const div = document.createElement('div');
            div.className = `card ${c.colorClass}`;
            let rankHtml = c.display;
            if(c.isSmallJoker) rankHtml = 'Joker';
            if(c.isBigJoker) rankHtml = 'JOKER';
            div.innerHTML = `<div class="rank-corner" style="font-size:14px">${rankHtml}</div>`;
            el.appendChild(div);
        });
    }

    // ç®€å•ç‰Œå‹æ£€æŸ¥ (å•å¼ ã€å¯¹å­ã€ç‚¸å¼¹ã€ç‹ç‚¸)
    checkType(cards) {
        const len = cards.length;
        if(len === 0) return null;
        const vals = cards.map(c => c.val).sort((a,b)=>a-b);
        
        if(len === 1) return { type: 'single', val: vals[0] };
        if(len === 2 && vals[0] === vals[1]) return { type: 'pair', val: vals[0] };
        if(len === 2 && vals[0] === 16 && vals[1] === 17) return { type: 'rocket', val: 99 };
        if(len === 4 && vals[0] === vals[3]) return { type: 'bomb', val: vals[0] };
        
        return null;
    }

    canBeat(my, target) {
        if(my.type === 'rocket') return true;
        if(target.type === 'rocket') return false;
        if(my.type === 'bomb' && target.type !== 'bomb') return true;
        if(my.type === target.type && my.val > target.val) return true;
        return false;
    }
}

const game = new Game();
</script>
</body>
</html>
