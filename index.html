<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ–—åœ°ä¸» - å¤§å¸ˆé‡åˆ¶ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-width: 56px;
            --card-height: 84px;
            --primary-color: #ffb800;
            --table-bg: #2d5a3f;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            background: radial-gradient(circle at center, #356b4b 0%, #1a3825 100%);
            font-family: 'Roboto Condensed', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* === æ¸¸æˆæ¡Œé¢åŒºåŸŸ (Top) === */
        #game-table {
            flex: 1;
            position: relative;
            width: 100%;
            perspective: 1000px;
        }

        /* åº•ç‰ŒåŒº */
        #top-bar {
            position: absolute;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            z-index: 10;
        }

        /* ç”µè„‘ç©å®¶ (å·¦/å³) */
        .player-avatar {
            position: absolute;
            top: 15%;
            width: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .player-avatar.left { left: 10px; }
        .player-avatar.right { right: 10px; }
        
        .avatar-icon {
            width: 40px; height: 40px; background: #ddd; border-radius: 50%;
            margin-bottom: 5px; display: flex; justify-content: center; align-items: center;
            font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .avatar-info { color: white; font-size: 12px; text-shadow: 0 1px 2px #000; text-align: center;}
        .role-badge { 
            font-size: 10px; padding: 2px 4px; border-radius: 4px; margin-top: 2px; 
            background: #555; color: #fff;
        }
        .role-badge.landlord { background: #d63031; }

        /* å‡ºç‰ŒåŒºåŸŸ (å·¦/ä¸­/å³) */
        .played-area {
            position: absolute;
            display: flex;
            gap: -25px;
            transform-style: preserve-3d;
        }
        .played-area .card { transform: scale(0.8); margin-right: -25px; } /* ç¼©å°å‡ºç‰Œ */

        #play-left { top: 30%; left: 90px; }
        #play-right { top: 30%; right: 90px; justify-content: flex-end; }
        #play-center { 
            top: 45%; left: 50%; 
            transform: translateX(-50%); 
            z-index: 20;
        }

        /* === ç©å®¶æ“ä½œåŒº (Bottom) === */
        #player-zone {
            height: 240px;
            position: relative;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding-bottom: 20px;
        }

        /* æç¤ºä¿¡æ¯ */
        #msg-toast {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: #ffb800;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #msg-toast.show { opacity: 1; }

        /* æŒ‰é’®ç»„ */
        #controls {
            position: absolute;
            top: 20px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 100;
        }

        .btn {
            background: linear-gradient(180deg, #ffdb4d 0%, #ffb800 100%);
            border: none;
            padding: 10px 28px;
            border-radius: 25px;
            color: #5a3a00;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 0 #cc9300, 0 8px 10px rgba(0,0,0,0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #cc9300, inset 0 2px 5px rgba(0,0,0,0.2); }
        .btn.blue { background: linear-gradient(180deg, #4dabf7 0%, #228be6 100%); color: #fff; box-shadow: 0 4px 0 #1864ab, 0 8px 10px rgba(0,0,0,0.4); }
        .btn:disabled { filter: grayscale(100%); opacity: 0.6; pointer-events: none; }

        /* æ‰‹ç‰Œå®¹å™¨ (æ‰‡å½¢) */
        #hand-container {
            position: relative;
            height: 140px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            /* ä¿®æ­£ï¼šç§»é™¤ overflow: hidden ä»¥å…è®¸ç‰Œå¼¹èµ· */
        }

        /* === æ‰‘å…‹ç‰Œé€šç”¨æ ·å¼ === */
        .card {
            width: var(--card-width);
            height: var(--card-height);
            background: #fff;
            border-radius: 6px;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.4);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 4px 0;
            font-size: 20px;
            line-height: 1;
            border: 1px solid #ccc;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }

        .card.back {
            background: #4a90e2;
            border: 2px solid #fff;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(255,255,255,0.1) 5px, rgba(255,255,255,0.1) 10px);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card.back::after { content: 'â™ '; color: rgba(255,255,255,0.3); font-size: 30px; }

        .card.red { color: #d63031; }
        .card.black { color: #2d3436; }
        
        .card .rank { font-weight: bold; font-family: 'Times New Roman', serif; }
        .card .suit { font-size: 14px; margin-top: 2px; }
        
        /* å¤§å›¾ (ä¸­é—´èŠ±è‰²) */
        .card .big-suit { 
            position: absolute; bottom: 5px; right: 5px; 
            font-size: 28px; opacity: 0.2; pointer-events: none; 
        }

        /* ç©å®¶æ‰‹ç‰Œç‰¹å®šæ ·å¼ */
        .my-card {
            position: absolute;
            transform-origin: 50% 120%; /* æ‰‡å½¢æ—‹è½¬ä¸­å¿ƒ */
            box-shadow: -2px 0 10px rgba(0,0,0,0.3);
        }
        .my-card.selected {
            transform: translateY(-20px) !important; /* é€‰ä¸­æ—¶ç›´æ¥ä¸Šæµ®ï¼Œè¦†ç›–æ—‹è½¬ */
            z-index: 100 !important;
            border: 2px solid #ffb800;
        }

        /* è½®æµæŒ‡ç¤ºå™¨ */
        .active-turn { border: 2px solid #ffb800; box-shadow: 0 0 15px #ffb800; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px #ffb800; } 50% { box-shadow: 0 0 20px #ffb800; } 100% { box-shadow: 0 0 5px #ffb800; } }

    </style>
</head>
<body>

    <div id="game-table">
        <div id="top-bar">
            <div class="card back" id="base-1"></div>
            <div class="card back" id="base-2"></div>
            <div class="card back" id="base-3"></div>
        </div>

        <div class="player-avatar left" id="avatar-west">
            <div class="avatar-icon">ğŸ¤–</div>
            <div class="avatar-info">
                <div>ç”µè„‘ (å·¦)</div>
                <div id="count-west">17</div>
                <div class="role-badge" id="role-west" style="display:none"></div>
            </div>
        </div>

        <div class="player-avatar right" id="avatar-east">
            <div class="avatar-icon">ğŸ¤ </div>
            <div class="avatar-info">
                <div>ç”µè„‘ (å³)</div>
                <div id="count-east">17</div>
                <div class="role-badge" id="role-east" style="display:none"></div>
            </div>
        </div>

        <div id="play-left" class="played-area"></div>
        <div id="play-right" class="played-area"></div>
        <div id="play-center" class="played-area"></div>
    </div>

    <div id="player-zone">
        <div id="msg-toast">è½®åˆ°ä½ äº†</div>
        
        <div id="controls">
            <button class="btn" id="btn-start" onclick="game.init()">å¼€å§‹æ¸¸æˆ</button>
            
            <div id="group-bid" style="display:none; gap:15px;">
                <button class="btn" onclick="game.playerBid(true)">å«åœ°ä¸»</button>
                <button class="btn blue" onclick="game.playerBid(false)">ä¸å«</button>
            </div>

            <div id="group-play" style="display:none; gap:15px;">
                <button class="btn blue" id="btn-pass" onclick="game.playerPass()">ä¸å‡º</button>
                <button class="btn" id="btn-submit" onclick="game.playerPlay()">å‡ºç‰Œ</button>
            </div>
        </div>

        <div id="hand-container">
            </div>
    </div>

<script>
/**
 * æ–—åœ°ä¸»æ ¸å¿ƒé€»è¾‘ - æç®€å•æ–‡ä»¶ç‰ˆ
 * ä¿®å¤äº†å‘ç‰ŒBugã€å®Œå–„äº†UIäº¤äº’
 */
const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const RANKS = ['3','4','5','6','7','8','9','10','J','Q','K','A','2'];
// æƒé‡å€¼ï¼š3=3 ... K=13, A=14, 2=15, å°ç‹=16, å¤§ç‹=17

class Card {
    constructor(val, suit = '', type = 'normal') {
        this.val = val; // æƒé‡
        this.suit = suit;
        this.type = type; // normal, joker
        this.selected = false;
        this.id = Math.random().toString(36).substr(2, 9);
    }
    
    get display() {
        if (this.val === 16) return 'S'; // Small Joker
        if (this.val === 17) return 'B'; // Big Joker
        return RANKS[this.val - 3];
    }

    get color() {
        if (this.suit === 'â™¥' || this.suit === 'â™¦' || this.val === 17) return 'red';
        return 'black';
    }
}

class Game {
    constructor() {
        this.reset();
        // DOM Elements
        this.els = {
            hand: document.getElementById('hand-container'),
            controls: {
                start: document.getElementById('btn-start'),
                bid: document.getElementById('group-bid'),
                play: document.getElementById('group-play'),
                pass: document.getElementById('btn-pass')
            },
            played: {
                west: document.getElementById('play-left'),
                east: document.getElementById('play-right'),
                south: document.getElementById('play-center')
            },
            base: [document.getElementById('base-1'), document.getElementById('base-2'), document.getElementById('base-3')],
            counts: {
                west: document.getElementById('count-west'),
                east: document.getElementById('count-east')
            },
            badges: {
                west: document.getElementById('role-west'),
                east: document.getElementById('role-east')
            },
            toast: document.getElementById('msg-toast'),
            avatars: {
                west: document.getElementById('avatar-west'),
                east: document.getElementById('avatar-east'),
                // south is implied active when controls show
            }
        };
    }

    reset() {
        this.deck = [];
        this.hands = { south: [], west: [], east: [] };
        this.baseCards = [];
        this.landlord = null;
        this.turn = null; // south, west, east
        this.status = 'idle'; // idle, bidding, playing
        this.lastPlay = null; // { player, cards, type, val }
        this.passCount = 0;
    }

    init() {
        this.reset();
        this.createDeck();
        this.shuffle();
        this.deal();
        
        // UI Reset
        this.els.controls.start.style.display = 'none';
        this.els.played.west.innerHTML = '';
        this.els.played.east.innerHTML = '';
        this.els.played.south.innerHTML = '';
        this.els.base.forEach(el => { el.className = 'card back'; el.innerHTML = ''; });
        this.els.badges.west.style.display = 'none';
        this.els.badges.east.style.display = 'none';
        
        this.renderHand();
        this.updateCounts();
        
        // Start Bidding (Simplified: Player always bids first)
        this.status = 'bidding';
        this.showToast('è¯·å«åœ°ä¸»');
        this.els.controls.bid.style.display = 'flex';
    }

    createDeck() {
        // 3-2 (3-15)
        for(let v=3; v<=15; v++) {
            for(let s of SUITS) {
                this.deck.push(new Card(v, s));
            }
        }
        this.deck.push(new Card(16, '', 'joker')); // å°ç‹
        this.deck.push(new Card(17, '', 'joker')); // å¤§ç‹
    }

    shuffle() {
        this.deck.sort(() => Math.random() - 0.5);
    }

    deal() {
        // 54 cards: 3 base, 51 / 3 = 17 each
        this.baseCards = this.deck.splice(0, 3);
        for(let i=0; i<17; i++) {
            this.hands.south.push(this.deck.pop());
            this.hands.west.push(this.deck.pop());
            this.hands.east.push(this.deck.pop());
        }
        this.sortHand('south');
        this.sortHand('west');
        this.sortHand('east');
    }

    sortHand(who) {
        this.hands[who].sort((a,b) => b.val - a.val); // Descending
    }

    // --- UI Rendering ---

    renderHand() {
        this.els.hand.innerHTML = '';
        const len = this.hands.south.length;
        // Fan Logic
        const angleSpan = Math.min(60, len * 3);
        const startAngle = -angleSpan / 2;
        const step = len > 1 ? angleSpan / (len - 1) : 0;

        this.hands.south.forEach((card, idx) => {
            const el = document.createElement('div');
            el.className = `card my-card ${card.color}`;
            if(card.selected) el.classList.add('selected');
            
            // Content
            let rankTxt = card.display;
            if(card.val === 16) rankTxt = 'JOKER';
            if(card.val === 17) rankTxt = 'JOKER';
            
            el.innerHTML = `
                <div class="rank">${rankTxt}</div>
                <div class="suit">${card.suit}</div>
                <div class="big-suit">${card.suit}</div>
            `;
            
            // Interaction
            el.onclick = () => {
                card.selected = !card.selected;
                this.renderHand(); // Re-render to update classes
            };

            // Style: Rotate and position
            const rot = startAngle + idx * step;
            // X offset to center
            // Y offset based on curve (Math.cos)
            const yOff = Math.abs(rot) * 0.5;
            
            el.style.transform = `rotate(${rot}deg) translateY(${yOff}px)`;
            // Adjust left margin to overlap
            el.style.left = `${(idx - (len-1)/2) * 20}px`; 
            // Reset position to center absolute
            el.style.position = 'absolute';
            el.style.bottom = '10px';
            el.style.zIndex = idx;

            if(card.selected) {
                // If selected, we override transform in CSS via !important, but let's keep it clean
            }

            this.els.hand.appendChild(el);
        });
    }

    updateCounts() {
        this.els.counts.west.innerText = this.hands.west.length;
        this.els.counts.east.innerText = this.hands.east.length;
    }

    showToast(msg) {
        this.els.toast.innerText = msg;
        this.els.toast.classList.add('show');
        setTimeout(() => this.els.toast.classList.remove('show'), 2000);
    }

    highlightAvatar(who) {
        this.els.avatars.west.classList.remove('active-turn');
        this.els.avatars.east.classList.remove('active-turn');
        // South indicator is the controls appearing
        if(who === 'west') this.els.avatars.west.classList.add('active-turn');
        if(who === 'east') this.els.avatars.east.classList.add('active-turn');
    }

    // --- Gameplay Logic ---

    playerBid(wants) {
        this.els.controls.bid.style.display = 'none';
        if(wants) {
            this.setLandlord('south');
        } else {
            // Randomly pick AI
            const r = Math.random();
            if(r > 0.5) this.setLandlord('east');
            else this.setLandlord('west');
        }
    }

    setLandlord(who) {
        this.landlord = who;
        this.hands[who].push(...this.baseCards);
        this.sortHand(who);
        
        // Show Base Cards
        this.els.base.forEach((el, i) => {
            const c = this.baseCards[i];
            el.className = `card ${c.color}`;
            el.innerHTML = `<div class="rank" style="font-size:14px">${c.display}</div>`;
        });

        // Set Badges
        if(who === 'west') {
            this.els.badges.west.innerText = 'åœ°ä¸»';
            this.els.badges.west.classList.add('landlord');
            this.els.badges.west.style.display = 'block';
        } else if (who === 'east') {
            this.els.badges.east.innerText = 'åœ°ä¸»';
            this.els.badges.east.classList.add('landlord');
            this.els.badges.east.style.display = 'block';
        } else {
            // I am landlord
            this.showToast('ä½ æ˜¯åœ°ä¸»ï¼');
        }

        this.updateCounts();
        if(who === 'south') this.renderHand();

        this.status = 'playing';
        this.turn = who;
        this.runTurn();
    }

    runTurn() {
        this.highlightAvatar(this.turn);
        
        if(this.turn === 'south') {
            // My turn
            this.els.controls.play.style.display = 'flex';
            // Enable/Disable Pass
            const isFirst = (this.lastPlay === null || this.lastPlay.player === 'south' || this.passCount >= 2);
            this.els.controls.pass.style.display = isFirst ? 'none' : 'block';
            this.showToast('è½®åˆ°ä½ å‡ºç‰Œ');
        } else {
            // AI Turn
            this.els.controls.play.style.display = 'none';
            setTimeout(() => this.aiPlay(), 1000);
        }
    }

    playerPass() {
        this.passCount++;
        this.renderPlayed('south', []);
        this.nextTurn();
    }

    playerPlay() {
        const selected = this.hands.south.filter(c => c.selected);
        if(selected.length === 0) {
            this.showToast('è¯·é€‰ç‰Œ');
            return;
        }

        const typeInfo = this.checkType(selected);
        if(!typeInfo) {
            this.showToast('ç‰Œå‹ä¸åˆæ³•');
            return;
        }

        // Check if can beat
        if(this.lastPlay && this.lastPlay.player !== 'south' && this.passCount < 2) {
            if(!this.canBeat(typeInfo, this.lastPlay)) {
                this.showToast('æ‰“ä¸è¿‡ä¸Šå®¶');
                return;
            }
        }

        // Play Success
        this.hands.south = this.hands.south.filter(c => !c.selected);
        this.renderHand();
        this.lastPlay = { player: 'south', ...typeInfo };
        this.passCount = 0;
        
        this.renderPlayed('south', selected);
        this.checkWin('south');
    }

    aiPlay() {
        const hand = this.hands[this.turn];
        let toPlay = [];
        
        // Simple AI Logic
        const isFree = (this.lastPlay === null || this.lastPlay.player === this.turn || this.passCount >= 2);
        
        if(isFree) {
            // Play smallest single
            toPlay = [hand[hand.length-1]];
        } else {
            // Try to beat
            // Very dumb AI: only beats singles or pairs
            const target = this.lastPlay;
            if(target.type === 'single') {
                const c = hand.slice().reverse().find(x => x.val > target.val);
                if(c) toPlay = [c];
            } else if (target.type === 'pair') {
                // find pair
                // ... (simplified for demo)
            }
        }

        if(toPlay.length > 0) {
            // Remove from hand
            this.hands[this.turn] = hand.filter(c => !toPlay.includes(c));
            this.updateCounts();
            
            const typeInfo = this.checkType(toPlay);
            this.lastPlay = { player: this.turn, ...typeInfo };
            this.passCount = 0;
            this.renderPlayed(this.turn, toPlay);
            this.checkWin(this.turn);
        } else {
            this.passCount++;
            this.renderPlayed(this.turn, []);
            this.nextTurn();
        }
    }

    nextTurn() {
        if(this.status !== 'playing') return;
        if(this.turn === 'south') this.turn = 'east'; // Counter-clockwise? usually CCW: South -> East(Right) -> West(Left) is WRONG.
        // Standard is Counter-Clockwise: South -> Right (East) -> Left (West)
        else if(this.turn === 'east') this.turn = 'west';
        else this.turn = 'south';
        
        // Reset lastPlay if everyone passed
        if(this.passCount >= 2) {
            // this.lastPlay = null; // Don't nullify, just ignore in logic
        }
        
        this.runTurn();
    }

    checkWin(who) {
        if(this.hands[who].length === 0) {
            this.status = 'ended';
            setTimeout(() => alert(who === 'south' ? 'ä½ èµ¢äº†ï¼' : 'ç”µè„‘èµ¢äº†ï¼'), 100);
            this.els.controls.start.style.display = 'block';
            this.els.controls.start.innerText = 'å†æ¥ä¸€å±€';
            this.els.controls.play.style.display = 'none';
        } else {
            if(who === 'south') this.nextTurn(); // only manual trigger for player
            else this.nextTurn(); // AI calls next automatically
        }
    }

    renderPlayed(who, cards) {
        const el = this.els.played[who];
        el.innerHTML = '';
        if(cards.length === 0) {
            const txt = document.createElement('div');
            txt.innerText = 'ä¸å‡º';
            txt.style.color = '#ddd';
            txt.style.fontWeight = 'bold';
            txt.style.padding = '5px 10px';
            txt.style.background = 'rgba(0,0,0,0.5)';
            txt.style.borderRadius = '4px';
            el.appendChild(txt);
            return;
        }

        cards.forEach(c => {
            const div = document.createElement('div');
            div.className = `card ${c.color}`;
            let rankTxt = c.display;
            if(c.val >=16) rankTxt = 'J';
            div.innerHTML = `<div class="rank">${rankTxt}</div><div class="suit">${c.suit}</div>`;
            el.appendChild(div);
        });
    }

    // --- Rule Checking (Simplified) ---
    checkType(cards) {
        const len = cards.length;
        if(len === 0) return null;
        const vals = cards.map(c => c.val).sort((a,b)=>a-b);
        
        if(len === 1) return { type: 'single', val: vals[0] };
        if(len === 2 && vals[0] === vals[1]) return { type: 'pair', val: vals[0] };
        if(len === 2 && vals[0] === 16 && vals[1] === 17) return { type: 'rocket', val: 99 };
        if(len === 4 && vals[0] === vals[3]) return { type: 'bomb', val: vals[0] };
        if(len === 3 && vals[0] === vals[2]) return { type: 'triplet', val: vals[0] };
        
        // ... Add more rules (straight, etc) here for full game
        return null; // Invalid for now
    }

    canBeat(my, target) {
        if(my.type === 'rocket') return true;
        if(target.type === 'rocket') return false;
        if(my.type === 'bomb' && target.type !== 'bomb') return true;
        
        if(my.type === target.type && my.cards.length === target.cards.length) { // simplified length check
            return my.val > target.val;
        }
        return false;
    }
}

const game = new Game();
</script>
</body>
</html>
